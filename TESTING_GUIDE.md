# DatabaseAI Testing Guide

Complete guide for testing the DatabaseAI system with automated scripts.

## ğŸ“‹ Table of Contents

1. [Overview](#overview)
2. [Test Database Setup](#test-database-setup)
3. [Database Verification](#database-verification)
4. [Automated API Testing](#automated-api-testing)
5. [Test Results](#test-results)
6. [Custom Test Queries](#custom-test-queries)

---

## ğŸ¯ Overview

This testing suite provides:
- **Network Management Database** with 5 interconnected tables
- **Sample Data** with realistic network device information
- **10+ Complex Queries** testing various SQL operations
- **Automated API Testing** with colorful terminal output
- **Performance Metrics** and success rate tracking

---

## ğŸ—„ï¸ Test Database Setup

### Step 1: Create Test Database

Run the database setup script to create tables and populate sample data:

```bash
python test_network_management_db.py
```

**What it creates:**

| Table | Records | Description |
|-------|---------|-------------|
| `hardware_info` | 10 | Hardware specifications (routers, switches, firewalls) |
| `device_status` | 5 | Status types (Online, Offline, Maintenance, Warning, Critical) |
| `network_devices` | 10 | Network devices with IPs and locations |
| `maintenance_logs` | 15 | Maintenance history records |
| `network_alerts` | 20 | Alert logs with severity levels |

**Relationships:**
```
hardware_info â†â†’ network_devices â†â†’ device_status
                      â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
              â†“               â†“
      maintenance_logs   network_alerts
```

### Expected Output:
```
================================================================================
NETWORK MANAGEMENT DATABASE SETUP
================================================================================

1. Dropping existing tables (if any)...
   âœ“ DROP TABLE IF EXISTS network_alerts CASCADE
   ...

2. Creating tables...
   âœ“ Created table: hardware_info
   ...

3. Inserting sample data...
   âœ“ Inserted 10 records into hardware_info
   ...

âœ“ Database setup completed successfully!
```

---

## âœ… Database Verification

### Step 2: Verify Database Structure

Before running API tests, verify that data is properly loaded:

```bash
python verify_database_data.py
```

**This script checks:**
- âœ“ All tables exist with correct schemas
- âœ“ Sample data is properly populated
- âœ“ Foreign key relationships work correctly
- âœ“ JOIN operations return expected results
- âœ“ Statistics and aggregations

### Expected Output:
```
====================================================================================================
                                       DATABASE VERIFICATION                                        
====================================================================================================

1. Checking Tables...
âœ“ Table 'hardware_info' exists with 10 rows
âœ“ Table 'device_status' exists with 5 rows
...

3. Checking Relationships...
âœ“ JOIN test (network_devices + hardware_info): 10 rows
âœ“ JOIN test (network_devices + device_status): 10 rows
...

4. Statistics...
Devices by Status:
   Online: 8 devices
   Warning: 2 devices
...

âœ“ Database structure verified successfully!
```

---

## ğŸš€ Automated API Testing

### Step 3: Run Automated Tests

The automated test script reads queries from `TEST_QUERIES.md` and tests them against your DatabaseAI API:

```bash
python test_api_automated.py
```

### Features:

#### ğŸ¨ **Colorful Terminal Output**
- ğŸŸ¢ Green for successful operations
- ğŸ”´ Red for errors
- ğŸŸ¡ Yellow for warnings/retries
- ğŸ”µ Blue for information
- ğŸŸ£ Magenta for SQL queries

#### ğŸ“Š **Detailed Metrics**
- Execution time per query
- Number of rows returned
- Retry count (if error recovery was needed)
- SQL query generated by LLM
- Success/failure status

#### ğŸ“ˆ **Test Summary**
- Overall success rate
- Total queries tested
- Average execution time
- Failed queries with error details
- Queries that needed retries
- Top 5 slowest queries

### Sample Output:
```
====================================================================================================
                                  AUTOMATED API TESTING - DatabaseAI                                        
====================================================================================================

Step 1: Connecting to Database
âœ“ Connected to database: testing
â„¹ Tables: 51

Step 2: Testing 10 Queries

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Query #1
Show me all offline devices
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Query executed successfully
â„¹    Rows returned: 0
â„¹    Total time: 12.45s
â„¹    Execution time: 0.008s
   SQL: SELECT * FROM network_devices WHERE status_id = (SELECT status_id FROM device_status...

...

====================================================================================================
                                            TEST SUMMARY                                        
====================================================================================================

Overall Statistics:
  Total Queries:      10
  Successful:         9 (90.0%)
  Failed:             1 (10.0%)
  Total Retries:      2
  Total Rows:         142
  Total Time:         125.67s
  Average Time:       12.57s

Success Rate:
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 9/10
```

---

## ğŸ“ Test Results

### JSON Output

After each test run, results are automatically saved to:
```
test_results_YYYYMMDD_HHMMSS.json
```

**JSON Structure:**
```json
{
  "timestamp": "2025-10-25T14:08:59.123456",
  "total_queries": 10,
  "successful": 9,
  "failed": 1,
  "results": [
    {
      "query_num": 1,
      "query_text": "Show me all offline devices",
      "status_code": 200,
      "elapsed_time": 12.45,
      "success": true,
      "row_count": 0,
      "sql_query": "SELECT * FROM...",
      "retry_count": 0,
      "execution_time": 0.008
    },
    ...
  ]
}
```

---

## ğŸ“ Custom Test Queries

### Modifying TEST_QUERIES.md

You can add your own test queries to `TEST_QUERIES.md`. The script supports two formats:

**Format 1: Numbered List**
```markdown
1. Show me all offline devices
2. Get critical alerts from last week
3. List devices that need maintenance
```

**Format 2: Markdown Headers**
```markdown
**Query 1:** Show me all offline devices

**Query 2:** Get critical alerts from last week

**Query 3:** List devices that need maintenance
```

### Sample Complex Queries

The test database includes 10 complex queries covering:

1. **Basic Queries**
   - Simple SELECT with WHERE clause
   - Filtering by status

2. **JOIN Queries**
   - 2-table joins (devices + hardware)
   - 3-table joins (devices + hardware + status)
   - LEFT JOINs with NULL handling

3. **Aggregation Queries**
   - COUNT with GROUP BY
   - Multiple aggregations (AVG, MAX, MIN)
   - HAVING clause

4. **Date/Time Queries**
   - Date range filtering
   - Relative dates (CURRENT_DATE, INTERVAL)

5. **Complex Conditions**
   - Multiple WHERE conditions with AND/OR
   - Subqueries
   - EXISTS clauses

6. **View Creation**
   - CREATE VIEW with JOINs
   - Type mismatch handling (tests error recovery)

---

## ğŸ”§ Configuration

### Database Configuration

The scripts use credentials from `config.yml`:

```yaml
database:
  host: localhost
  port: 5432
  database: testing
  user: postgres
  password: your_password
```

### API Configuration

API endpoint is configured in `test_api_automated.py`:

```python
API_BASE_URL = "http://localhost:8088/api/v1"
```

---

## ğŸ¯ Test Coverage

### What Gets Tested:

âœ… **LLM SQL Generation**
- Natural language to SQL conversion
- Multiple LLM providers (OpenAI, vLLM, Ollama)
- JSON response parsing

âœ… **Error Recovery**
- Automatic retry on failures
- Error analysis and hints
- Type mismatch detection and fixing

âœ… **SQL Execution**
- Query execution against PostgreSQL
- Result formatting
- Performance tracking

âœ… **Complex Scenarios**
- Multi-table JOINs
- Aggregations
- Date/time operations
- View creation
- Type casting

---

## ğŸ“Š Performance Benchmarks

### Typical Performance:

| Query Type | Avg Time | Success Rate |
|------------|----------|--------------|
| Simple SELECT | 5-8s | 100% |
| 2-table JOIN | 8-12s | 95% |
| 3-table JOIN | 12-18s | 90% |
| Aggregation | 10-15s | 95% |
| View Creation | 15-20s | 85% |

*Note: Times include LLM generation + SQL execution + network latency*

---

## ğŸ› Troubleshooting

### Common Issues:

**1. Database Connection Failed**
```
âœ— Connection failed: password authentication failed
```
**Solution:** Check `config.yml` for correct database credentials

**2. No Queries Found**
```
âœ— No queries found in TEST_QUERIES.md
```
**Solution:** Ensure TEST_QUERIES.md exists and contains properly formatted queries

**3. API Not Responding**
```
âœ— Connection error: Connection refused
```
**Solution:** Make sure the backend is running:
```bash
python run_backend.py
```

**4. LLM Timeout**
```
âœ— Query failed: vLLM API returned 400
```
**Solution:** The query is too complex for the model's context window. Try:
- Reducing max_tokens in `app_config.yml`
- Simplifying the query
- Using a smaller schema

---

## ğŸ“ Best Practices

### Writing Good Test Queries:

1. **Be Specific** - "Show offline routers" vs "Show devices"
2. **Test Edge Cases** - Empty results, NULLs, type mismatches
3. **Vary Complexity** - Mix simple and complex queries
4. **Include Joins** - Test relationship handling
5. **Use Real Scenarios** - Queries that users would actually ask

### Interpreting Results:

- **100% Success** - Excellent! Agent is working well
- **90-99% Success** - Good, some complex queries may need tuning
- **80-89% Success** - Acceptable, check failed queries for patterns
- **<80% Success** - Investigate LLM configuration or schema issues

### Monitoring Retries:

- **0-1 Retries** - Normal, expected for complex queries
- **2-3 Retries** - Agent learning, may need prompt tuning
- **4+ Retries** - Check error messages, may indicate systemic issue

---

## ğŸ“š Additional Resources

- **SQL_AGENT_GUIDE.md** - Deep dive into the SQL agent architecture
- **TOKEN_OPTIMIZATION.md** - Optimizing token usage
- **AGENT_IMPROVEMENTS.md** - Latest agent enhancements
- **README_APP.md** - Application setup and configuration

---

## ğŸ‰ Success Criteria

Your DatabaseAI is working correctly if:

âœ“ Database verification completes without errors
âœ“ API connection succeeds
âœ“ Success rate â‰¥ 80%
âœ“ Complex queries (3+ table JOINs) execute successfully
âœ“ Error recovery works (retries fix issues)
âœ“ Results are returned in reasonable time (<30s per query)

---

Happy Testing! ğŸš€
